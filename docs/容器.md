### 容器

---

#### Docker

作用：环境隔离，与虚拟机相比，占用资源更少，体积小，操作更简单，启动快。

主要用途：

- 提供一次性的环境

- 提供弹性云服务

- 组件微服务架构

  

#### Docker 基本命令

**拉取镜像**

```shell
docker pull $IMAGE:$TAG
```

**启动容器**

```shell
docker run -itd centos:7.8.2003 bash
```

​	-i ：交互式操作

​	-t ：终端

​	-d：后台运行

​	-e：设置环境变量

​	--security-opt：安全选项

​	--network：默认 `bridge` 模式(桥接网络)，可选 `host` 模式， `none` 模式

​	--name：容器名字

​	-m：内存量

​	--cpus：cpu资源量

​	-v：添加数据卷

​	-v：hostPATH:containerPATH 挂载数据卷

​	-p：端口映射

​	bash 放在镜像名后面是命令，退出终端用 exit 或 ctr + D

......

**进入容器**

```shell
docker exec -it $CONTAINER_ID bash
```

**删除容器**

```shell
docker rm -f $CONTAINER_ID
```



#### 以容器化 rgw 为例

#### 需求

将 rgw 部署在容器内，将 rgw 配置信息同步到所有节点，保持一致，rgw 容器以守护进程方式运行。

#### Step

1. 制作镜像
2. 部署和管理容器

##### 制作镜像

使用 `Dockerfile` 构建镜像，`Dockerfile` 是一个用来构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明

cat Dockerfile

```shell
FROM centos:7.8.2003
COPY ./test/imgs/tyds /tmp/imgs/tyds
COPY ./test/imgs/3rdparty /tmp/imgs/3rdparty
COPY ./tyds.repo /etc/yum.repos.d/

RUN yum install tyds-radosgw -y
RUN yum install net-tools.x86_64 -y
```

FROM ：指定基础镜像

COPY：复制文件

RUN：用于执行后面的命令行

CMD：类似于 RUN，不过是在 docker run 时运行命令

......

**构建镜像**

docker build -t  tyds-rgw  .

也可拉取基础镜像后通过 commit 制作镜像。

一些脚本（161）：/root/jiaxiang/yq/Docker



#### 容器管理

（1） Docker Compose

Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，您可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。

（2）Kubernetes

kubernetes 是一个开源的容器编排平台，可以自动完成在部署、管理和扩展容器化应用过程中涉及的许多手动操作。

##### 部署 k8s

https://segmentfault.com/a/1190000040107263



编写配置文件

cat rgwtest.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tyds-rgw-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tyds-rgw
  template:
    metadata:
      labels:
        app: tyds-rgw
    spec:
      hostNetwork: true
      containers:
      - name: tyds-rgw
        image: tyds-rgw:k8s
        imagePullPolicy: Never
        command: ["bash", "-c"]
        args: ["radosgw -f --cluster tyds --name client.rgw.$HOSTNAME --setuser tyds --setgroup tyds"]
        ports:
        - containerPort: 9090
        volumeMounts:
        - mountPath: /etc/tyds
          name: tyds-conf
      volumes:
      - name: tyds-conf
        hostPath:
          path: /etc/tyds
```

在 master 节点使配置生效

```shell
kubectl apply -f rgwtest.yaml
```

**一些概念**

1. Pods。最小管理单元，可理解为容器
2. replicas。副本数
3. service。一组 Pods 策略的抽象。
4. hostnetwork。是否使用主机网络
5. image。基础镜像
6. imagePullPolicy。镜像拉取策略，never表示只使用本地镜像。
7. commands 和 args 表示传入容器的命令。
8. ports。端口映射
9. volumes/volumeMounts。目录挂载。

**rgw 与集群通信**

​	设置共享目录，rgw 可以读到 tyds 的配置文件，从而获取集群配置信息（也可通过 k8s 设置 configMap）

​	端口映射，可以接收客户端的请求。

**节点一致性**

​	kind 设置为 Daemonset，可以保证集群中所有节点能运行相同的 pod 副本。每当新的节点加入，启动 pod 副本，新的节点剔除，则销毁 pod 资源。



#### 其它

##### 容器镜像优化

- 选用更小的基础镜像
- Dockerfile 串联优化
- 多阶段构建
- 其它

##### K8s 容器通信网络选取策略

**其它一些测试脚本（161）**

/root/jiaxiang/yq/k8s/app